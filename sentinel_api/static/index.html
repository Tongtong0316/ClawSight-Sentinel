<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClawSight Sentinel - ç½‘ç»œç›‘æ§ä¸­å¿ƒ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }
    .header {
      background: #1e293b;
      padding: 1.25rem 2rem;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5rem; color: #38bdf8; }
    .header .status { display: flex; align-items: center; gap: 0.5rem; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.25rem;
      border: 1px solid #334155;
    }
    .card h2 { font-size: 0.875rem; color: #94a3b8; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #334155; }
    .metric:last-child { border-bottom: none; }
    .metric-value { font-size: 1.5rem; font-weight: 600; color: #38bdf8; }
    .metric-value.warning { color: #f59e0b; }
    .metric-value.critical { color: #ef4444; }
    .metric-value.success { color: #22c55e; }
    .metric-label { color: #94a3b8; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .alert.critical { background: #7f1d1d; border: 1px solid #ef4444; }
    .alert.warning { background: #78350f; border: 1px solid #f59e0b; }
    .alert.info { background: #1e3a5f; border: 1px solid #38bdf8; }
    .device-list { max-height: 300px; overflow-y: auto; }
    .device-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; }
    .device-item:hover { background: #334155; }
    .device-ip { font-family: monospace; }
    .device-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .device-status.online { background: #166534; color: #86efac; }
    .device-status.offline { background: #7f1d1d; color: #fca5a5; }
    .refresh-btn { background: #38bdf8; color: #0f172a; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
    .refresh-btn:hover { background: #0ea5e9; }
    .api-card { background: #0f172a; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
    .api-card code { color: #38bdf8; font-size: 0.85rem; }
    .api-card p { color: #94a3b8; font-size: 0.85rem; margin-top: 0.25rem; }
    .info-box { background: #1e3a5f; border: 1px solid #38bdf8; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .info-box h3 { color: #38bdf8; font-size: 1rem; margin-bottom: 0.5rem; }
    .info-box p { color: #cbd5f5; font-size: 0.9rem; }
    .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn { background: #334155; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    .btn:hover { background: #475569; }
    .btn-primary { background: #2563eb; }
    .btn-primary:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>ğŸ›¡ï¸ ClawSight Sentinel</h1>
      <p style="color:#94a3b8;font-size:0.9rem;margin-top:0.25rem;">ç½‘ç»œç›‘æ§ä¸­å¿ƒ - API é©±åŠ¨æ¶æ„</p>
    </div>
    <div class="status">
      <div class="status-dot"></div>
      <span>è¿è¡Œä¸­</span>
      <button class="refresh-btn" onclick="refreshData()">åˆ·æ–°</button>
    </div>
  </div>

  <div class="container">
    <!-- æ¶æ„è¯´æ˜ -->
    <div class="info-box">
      <h3>ğŸ“¡ æ¶æ„è¯´æ˜</h3>
      <p>æœ¬ç³»ç»Ÿé‡‡ç”¨ <strong>API é©±åŠ¨æ¶æ„</strong>ï¼Œä¸è¿è¡Œæœ¬åœ°å¤§æ¨¡å‹ã€‚ç½‘ç»œåˆ†æç”±å¤–éƒ¨ Agent è°ƒç”¨ API å®Œæˆã€‚</p>
      <p style="margin-top:0.5rem;">å¤–éƒ¨ Agent å¯é€šè¿‡ <code>/agent/guide</code> è·å–å®Œæ•´æ¥å…¥æŒ‡å—ã€‚</p>
    </div>

    <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
    <div class="grid">
      <div class="card">
        <h2>ğŸ“Š è®¾å¤‡çŠ¶æ€</h2>
        <div class="metric">
          <span class="metric-label">åœ¨çº¿è®¾å¤‡</span>
          <span class="metric-value success" id="online-devices">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">ç¦»çº¿è®¾å¤‡</span>
          <span class="metric-value" id="offline-devices">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ€»è®¾å¤‡</span>
          <span class="metric-value" id="total-devices">-</span>
        </div>
      </div>

      <div class="card">
        <h2>ğŸŒ ç½‘ç»œæŒ‡æ ‡</h2>
        <div class="metric">
          <span class="metric-label">ä¸¢åŒ…ç‡</span>
          <span class="metric-value" id="packet-loss">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">å¹³å‡å»¶è¿Ÿ</span>
          <span class="metric-value" id="latency">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">å¸¦å®½ä¸‹è¡Œ</span>
          <span class="metric-value" id="bandwidth-in">-</span>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¶ WiFi çŠ¶æ€</h2>
        <div class="metric">
          <span class="metric-label">2.4G è®¾å¤‡</span>
          <span class="metric-value" id="wifi-2g">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">5G è®¾å¤‡</span>
          <span class="metric-value" id="wifi-5g">-</span>
        </div>
        <div class="metric">
          <span class="metric-label">æ€»è¿æ¥æ•°</span>
          <span class="metric-value" id="wifi-total">-</span>
        </div>
      </div>
    </div>

    <!-- API å¿«é€Ÿè®¿é—® -->
    <div class="grid">
      <div class="card">
        <h2>ğŸ”Œ API å¿«é€Ÿè®¿é—®</h2>
        <div class="api-card">
          <code>GET /api/v2/metrics/summary</code>
          <p>ç½‘ç»œå¥åº·æ‘˜è¦</p>
        </div>
        <div class="api-card">
          <code>GET /api/v2/narrator/report</code>
          <p>å®Œæ•´åˆ†ææŠ¥å‘Šï¼ˆè‡ªç„¶è¯­è¨€ï¼‰</p>
        </div>
        <div class="api-card">
          <code>GET /api/v2/wifi/scan</code>
          <p>WiFi ç¯å¢ƒæ‰«æ</p>
        </div>
        <div class="api-card">
          <code>GET /agent/guide</code>
          <p>Agent æ¥å…¥æŒ‡å—</p>
        </div>
      </div>

      <!-- å‘Šè­¦åŒºåŸŸ -->
      <div class="card">
        <h2>âš ï¸ å‘Šè­¦</h2>
        <div id="alerts"></div>
      </div>
    </div>

    <!-- è®¾å¤‡åˆ—è¡¨ -->
    <div class="grid">
      <div class="card">
        <h2>ğŸ–¥ï¸ åœ¨çº¿è®¾å¤‡</h2>
        <div class="device-list" id="online-list"></div>
      </div>
      <div class="card">
        <h2>ğŸ“´ ç¦»çº¿è®¾å¤‡</h2>
        <div class="device-list" id="offline-list"></div>
      </div>
    </div>
  </div>

  <script>
    async function refreshData() {
      try {
        const resp = await fetch('/api/v2/metrics/full');
        const data = await resp.json();

        const summary = data.summary || {};

        // æ›´æ–°æŒ‡æ ‡
        document.getElementById('online-devices').textContent = summary.online_devices || 0;
        document.getElementById('offline-devices').textContent = summary.offline_devices || 0;
        document.getElementById('total-devices').textContent = summary.total_devices || 0;

        // ç½‘ç»œæŒ‡æ ‡
        const plEl = document.getElementById('packet-loss');
        plEl.textContent = (summary.packet_loss || 0) + '%';
        plEl.className = 'metric-value' + ((summary.packet_loss || 0) > 1 ? ' warning' : '');

        document.getElementById('latency').textContent = (summary.avg_latency_ms || 0) + ' ms';
        document.getElementById('bandwidth-in').textContent = (summary.bandwidth_in_mbps || 0).toFixed(1) + ' Mbps';

        // WiFi
        const wifi = data.wifi_stats || {};
        document.getElementById('wifi-2g').textContent = wifi.band_2g_clients || 0;
        document.getElementById('wifi-5g').textContent = wifi.band_5g_clients || 0;
        document.getElementById('wifi-total').textContent = wifi.total_clients || 0;

        // å‘Šè­¦
        const alertsEl = document.getElementById('alerts');
        const alerts = summary.alerts || [];
        if (alerts.length > 0) {
          alertsEl.innerHTML = alerts.map(a => `<div class="alert info">${a}</div>`).join('');
        } else {
          alertsEl.innerHTML = '<div class="alert info">ç½‘ç»œè¿è¡Œæ­£å¸¸</div>';
        }

        // è®¾å¤‡åˆ—è¡¨
        const devices = data.device_status?.devices || [];
        const online = devices.filter(d => d.status === 'online').slice(0, 10);
        const offline = devices.filter(d => d.status === 'offline');

        document.getElementById('online-list').innerHTML = online.map(d =>
          `<div class="device-item"><span class="device-ip">${d.ip}</span><span class="device-status online">åœ¨çº¿</span></div>`
        ).join('') || '<div style="color:#94a3b8;">æ— </div>';

        document.getElementById('offline-list').innerHTML = offline.map(d =>
          `<div class="device-item"><span class="device-ip">${d.ip}</span><span class="device-status offline">ç¦»çº¿</span></div>`
        ).join('') || '<div style="color:#94a3b8;">æ— </div>';

      } catch (e) {
        console.error(e);
      }
    }

    // åˆå§‹åŠ è½½
    refreshData();
    // æ¯ 30 ç§’åˆ·æ–°
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
