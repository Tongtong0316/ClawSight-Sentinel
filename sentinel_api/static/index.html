<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClawSight Sentinel - ç½‘ç»œç›‘æ§ä¸­å¿ƒ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
    .header { background: #1e293b; padding: 1rem 2rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.5rem; color: #38bdf8; }
    .nav { display: flex; gap: 0.5rem; }
    .nav-btn { background: #334155; color: #e2e8f0; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    .nav-btn:hover { background: #475569; }
    .nav-btn.active { background: #2563eb; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
    .card { background: #1e293b; border-radius: 12px; padding: 1.25rem; border: 1px solid #334155; }
    .card h2 { font-size: 0.875rem; color: #94a3b8; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #334155; }
    .metric:last-child { border-bottom: none; }
    .metric-value { font-size: 1.5rem; font-weight: 600; color: #38bdf8; }
    .metric-value.warning { color: #f59e0b; }
    .metric-value.success { color: #22c55e; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .alert.info { background: #1e3a5f; border: 1px solid #38bdf8; }
    .device-list, .log-list { max-height: 350px; overflow-y: auto; }
    .device-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; }
    .device-item:hover { background: #334155; }
    .device-ip { font-family: monospace; }
    .device-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .device-status.online { background: #166534; color: #86efac; }
    .device-status.offline { background: #7f1d1d; color: #fca5a5; }
    .refresh-btn { background: #38bdf8; color: #0f172a; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
    /* WiFi é¡µé¢æ ·å¼ */
    .wifi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .wifi-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; }
    .wifi-ssid { font-weight: 600; font-size: 1.1rem; color: #fff; word-break: break-all; }
    .wifi-bssid { font-family: monospace; color: #94a3b8; font-size: 0.85rem; }
    .wifi-signal { display: flex; align-items: center; gap: 0.5rem; margin: 0.75rem 0; }
    .signal-bar { height: 8px; background: #334155; border-radius: 4px; flex: 1; overflow: hidden; }
    .signal-fill { height: 100%; background: #22c55e; transition: width 0.3s; }
    .signal-fill.weak { background: #ef4444; }
    .signal-fill.medium { background: #f59e0b; }
    .wifi-meta { display: flex; gap: 1rem; font-size: 0.85rem; color: #94a3b8; }
    .wifi-meta span { display: flex; align-items: center; gap: 0.25rem; }
    .channel-badge { background: #2563eb; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    /* æ—¥å¿—æŸ¥è¯¢ */
    .log-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .log-controls input, .log-controls select { background: #0f172a; color: #fff; border: 1px solid #334155; padding: 0.5rem; border-radius: 6px; }
    .log-controls input::placeholder { color: #64748b; }
    .log-entry { font-size: 0.85rem; padding: 0.5rem; border-bottom: 1px solid #334155; font-family: monospace; }
    .log-entry .time { color: #64748b; }
    .log-entry .level { padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.7rem; margin-right: 0.5rem; }
    .log-entry .level.error { background: #7f1d1d; color: #fca5a5; }
    .log-entry .level.warn { background: #78350f; color: #fbbf24; }
    .log-entry .level.info { background: #1e3a5f; color: #38bdf8; }
    .pagination { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
    .pagination button { background: #334155; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination button.active { background: #2563eb; }
    .page-info { color: #94a3b8; font-size: 0.85rem; align-self: center; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ›¡ï¸ ClawSight Sentinel</h1>
    <div class="nav">
      <button class="nav-btn active" onclick="showPage('dashboard')">ä»ªè¡¨ç›˜</button>
      <button class="nav-btn" onclick="showPage('wifi')">WiFi</button>
      <button class="nav-btn" onclick="showPage('logs')">æ—¥å¿—</button>
    </div>
  </div>

  <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
  <div id="page-dashboard" class="container">
    <div class="info-box" style="background: #1e3a5f; border: 1px solid #38bdf8; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
      <p style="color: #cbd5f5;"><strong>ğŸ“¡ æ¶æ„è¯´æ˜ï¼š</strong>æœ¬ç³»ç»Ÿé‡‡ç”¨ <strong>API é©±åŠ¨æ¶æ„</strong>ï¼Œä¸è¿è¡Œæœ¬åœ°å¤§æ¨¡å‹ã€‚ç½‘ç»œåˆ†æç”±å¤–éƒ¨ Agent è°ƒç”¨ API å®Œæˆã€‚</p>
    </div>
    <div class="grid">
      <div class="card">
        <h2>ğŸ“Š è®¾å¤‡çŠ¶æ€</h2>
        <div class="metric"><span class="metric-label">åœ¨çº¿è®¾å¤‡</span><span class="metric-value success" id="online-devices">-</span></div>
        <div class="metric"><span class="metric-label">ç¦»çº¿è®¾å¤‡</span><span class="metric-value" id="offline-devices">-</span></div>
        <div class="metric"><span class="metric-label">æ€»è®¾å¤‡</span><span class="metric-value" id="total-devices">-</span></div>
      </div>
      <div class="card">
        <h2>ğŸŒ ç½‘ç»œæŒ‡æ ‡</h2>
        <div class="metric"><span class="metric-label">ä¸¢åŒ…ç‡</span><span class="metric-value" id="packet-loss">-</span></div>
        <div class="metric"><span class="metric-label">å¹³å‡å»¶è¿Ÿ</span><span class="metric-value" id="latency">-</span></div>
        <div class="metric"><span class="metric-label">å¸¦å®½ä¸‹è¡Œ</span><span class="metric-value" id="bandwidth-in">-</span></div>
      </div>
      <div class="card">
        <h2>ğŸ“¶ WiFi çŠ¶æ€</h2>
        <div class="metric"><span class="metric-label">2.4G è®¾å¤‡</span><span class="metric-value" id="wifi-2g">-</span></div>
        <div class="metric"><span class="metric-label">5G è®¾å¤‡</span><span class="metric-value" id="wifi-5g">-</span></div>
        <div class="metric"><span class="metric-label">æ€»è¿æ¥æ•°</span><span class="metric-value" id="wifi-total">-</span></div>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <h2>ğŸ”Œ API å¿«é€Ÿè®¿é—®</h2>
        <div style="background:#0f172a;padding:0.75rem;border-radius:6px;margin-bottom:0.5rem;"><code style="color:#38bdf8;">GET /api/v2/metrics/summary</code><p style="color:#94a3b8;font-size:0.85rem;margin-top:0.25rem;">ç½‘ç»œå¥åº·æ‘˜è¦</p></div>
        <div style="background:#0f172a;padding:0.75rem;border-radius:6px;margin-bottom:0.5rem;"><code style="color:#38bdf8;">GET /api/v2/narrator/report</code><p style="color:#94a3b8;font-size:0.85rem;margin-top:0.25rem;">å®Œæ•´åˆ†ææŠ¥å‘Š</p></div>
        <div style="background:#0f172a;padding:0.75rem;border-radius:6px;"><code style="color:#38bdf8;">GET /agent/guide</code><p style="color:#94a3b8;font-size:0.85rem;margin-top:0.25rem;">Agent æ¥å…¥æŒ‡å—</p></div>
      </div>
      <div class="card"><h2>âš ï¸ å‘Šè­¦</h2><div id="alerts"></div></div>
    </div>
    <div class="grid">
      <div class="card"><h2>ğŸ–¥ï¸ åœ¨çº¿è®¾å¤‡</h2><div class="device-list" id="online-list"></div></div>
      <div class="card"><h2>ğŸ“´ ç¦»çº¿è®¾å¤‡</h2><div class="device-list" id="offline-list"></div></div>
    </div>
  </div>

  <!-- WiFi é¡µé¢ -->
  <div id="page-wifi" class="container hidden">
    <div class="grid">
      <div class="card"><h2>ğŸ“¶ é‚»è¿‘ WiFi ç½‘ç»œ</h2><div class="wifi-grid" id="wifi-networks"></div></div>
    </div>
    <div class="grid">
      <div class="card"><h2>ğŸ“Š 2.4G ä¿¡é“çŠ¶æ€</h2><div id="channels-2g"></div></div>
      <div class="card"><h2>ğŸ“Š 5G ä¿¡é“çŠ¶æ€</h2><div id="channels-5g"></div></div>
    </div>
  </div>

  <!-- æ—¥å¿—é¡µé¢ -->
  <div id="page-logs" class="container hidden">
    <div class="card">
      <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—æŸ¥è¯¢</h2>
      <div class="log-controls">
        <input type="text" id="log-search" placeholder="æœç´¢å…³é”®è¯..." style="flex:1;min-width:200px;">
        <select id="log-level"><option value="">å…¨éƒ¨çº§åˆ«</option><option value="error">Error</option><option value="warn">Warning</option><option value="info">Info</option></select>
        <button class="refresh-btn" onclick="loadLogs()">æŸ¥è¯¢</button>
      </div>
      <div class="log-list" id="log-entries"></div>
      <div class="pagination">
        <button id="btn-prev" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="page-info">1 / 1</span>
        <button id="btn-next" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const pageSize = 50;
    let allLogs = [];

    function showPage(page) {
      document.querySelectorAll('.container').forEach(p => p.classList.add('hidden'));
      document.getElementById('page-' + page).classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if (page === 'dashboard') refreshData();
      if (page === 'wifi') loadWifi();
      if (page === 'logs') loadLogs();
    }

    async function refreshData() {
      try {
        const resp = await fetch('/api/v2/metrics/full');
        const data = await resp.json();
        const summary = data.summary || {};
        document.getElementById('online-devices').textContent = summary.online_devices || 0;
        document.getElementById('offline-devices').textContent = summary.offline_devices || 0;
        document.getElementById('total-devices').textContent = summary.total_devices || 0;
        const plEl = document.getElementById('packet-loss');
        plEl.textContent = (summary.packet_loss || 0) + '%';
        plEl.className = 'metric-value' + ((summary.packet_loss || 0) > 1 ? ' warning' : '');
        document.getElementById('latency').textContent = (summary.avg_latency_ms || 0) + ' ms';
        document.getElementById('bandwidth-in').textContent = (summary.bandwidth_in_mbps || 0).toFixed(1) + ' Mbps';
        const wifi = data.wifi_stats || {};
        document.getElementById('wifi-2g').textContent = wifi.band_2g_clients || 0;
        document.getElementById('wifi-5g').textContent = wifi.band_5g_clients || 0;
        document.getElementById('wifi-total').textContent = wifi.total_clients || 0;
        const alerts = summary.alerts || [];
        document.getElementById('alerts').innerHTML = alerts.length ? alerts.map(a => '<div class="alert info">' + a + '</div>').join('') : '<div class="alert info">ç½‘ç»œè¿è¡Œæ­£å¸¸</div>';
        const devices = data.device_status?.devices || [];
        const online = devices.filter(d => d.status === 'online').slice(0, 10);
        const offline = devices.filter(d => d.status === 'offline');
        document.getElementById('online-list').innerHTML = online.map(d => '<div class="device-item"><span class="device-ip">' + d.ip + '</span><span class="device-status online">åœ¨çº¿</span></div>').join('') || '<div style="color:#94a3b8;">æ— </div>';
        document.getElementById('offline-list').innerHTML = offline.map(d => '<div class="device-item"><span class="device-ip">' + d.ip + '</span><span class="device-status offline">ç¦»çº¿</span></div>').join('') || '<div style="color:#94a3b8;">æ— </div>';
      } catch (e) { console.error(e); }
    }

    async function loadWifi() {
      try {
        const resp = await fetch('/api/v2/wifi/scan');
        const data = await resp.json();
        const networks = data.networks || [];
        const html = networks.map(n => {
          const signalClass = n.signal < -70 ? 'weak' : (n.signal < -60 ? 'medium' : '');
          return '<div class="wifi-card"><div class="wifi-ssid">' + (n.ssid || '(éšè—)') + '</div><div class="wifi-bssid">' + n.bssid + '</div><div class="wifi-signal"><div class="signal-bar"><div class="signal-fill ' + signalClass + '" style="width:' + n.signal_percent + '%"></div></div><span>' + n.signal + ' dBm</span></div><div class="wifi-meta"><span class="channel-badge">CH ' + n.channel + '</span><span>' + n.band + '</span><span>' + n.security + '</span></div></div>';
        }).join('');
        document.getElementById('wifi-networks').innerHTML = html || '<div style="color:#94a3b8;">æœªæ£€æµ‹åˆ°WiFiç½‘ç»œ</div>';
      } catch (e) { document.getElementById('wifi-networks').innerHTML = '<div style="color:#ef4444;">WiFiæ‰«æå¤±è´¥: ' + e.message + '</div>'; }
    }

    async function loadLogs() {
      try {
        const resp = await fetch('/api/v2/logs/recent?limit=500');
        const data = await resp.json();
        allLogs = data.logs || [];
        renderLogs();
      } catch (e) { document.getElementById('log-entries').innerHTML = '<div style="color:#ef4444;">æ—¥å¿—åŠ è½½å¤±è´¥</div>'; }
    }

    function renderLogs() {
      const search = document.getElementById('log-search').value.toLowerCase();
      const level = document.getElementById('log-level').value;
      let filtered = allLogs.filter(log => {
        if (level && (log.level || '').toLowerCase() !== level) return false;
        if (search) {
          const txt = (log.message || '').toLowerCase() + (log.source || '').toLowerCase();
          return txt.includes(search);
        }
        return true;
      });
      const totalPages = Math.ceil(filtered.length / pageSize) || 1;
      if (currentPage > totalPages) currentPage = 1;
      const start = (currentPage - 1) * pageSize;
      const pageLogs = filtered.slice(start, start + pageSize);
      const html = pageLogs.map(log => {
        const lvl = (log.level || 'info').toLowerCase();
        return '<div class="log-entry"><span class="time">' + (log.timestamp || '').split('T')[1]?.split('.')[0] + '</span><span class="level ' + lvl + '">' + lvl + '</span>' + (log.message || '') + '</div>';
      }).join('');
      document.getElementById('log-entries').innerHTML = html || '<div style="color:#94a3b8;padding:1rem;">æš‚æ— æ—¥å¿—</div>';
      document.getElementById('page-info').textContent = currentPage + ' / ' + totalPages;
      document.getElementById('btn-prev').disabled = currentPage <= 1;
      document.getElementById('btn-next').disabled = currentPage >= totalPages;
    }

    function changePage(delta) {
      currentPage += delta;
      renderLogs();
    }

    document.getElementById('log-search').addEventListener('input', () => { currentPage = 1; renderLogs(); });
    document.getElementById('log-level').addEventListener('change', () => { currentPage = 1; renderLogs(); });

    refreshData();
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
